---
/**
 * Componente para renderizar ecuaciones LaTeX/KaTeX en Astro
 * Soluciona el conflicto entre las llaves {} de LaTeX y las expresiones JavaScript de Astro
 * Incluye manejo responsivo con scroll automático para ecuaciones largas
 * 
 * @param formula - La ecuación LaTeX (sin delimitadores)
 * @param display - Si true, muestra la ecuación en bloque (centrada), si false en línea
 * 
 * Ejemplos:
 * <Latex formula="E = mc^2" />
 * <Latex formula="\frac{a}{b}" display={true} />
 */

// Importar estilos CSS (Astro los procesará automáticamente)
import '../styles/latex.css';

export interface Props {
  formula: string;
  display?: boolean;
}

const { formula, display = false } = Astro.props;

// Usar los delimitadores que KaTeX reconoce y que no conflictúan con Astro
const wrappedFormula = display 
  ? `\\[${formula}\\]`
  : `\\(${formula}\\)`;
---

{display ? (
  <div class="katex-display-wrapper">
    <div set:html={wrappedFormula}></div>
  </div>
) : (
  <span class="katex-inline-wrapper" set:html={wrappedFormula}></span>
)}

<script>
  // Detectar si las ecuaciones display tienen scroll y manejar eventos
  document.addEventListener('DOMContentLoaded', () => {
    const displayWrappers = document.querySelectorAll('.katex-display-wrapper');
    
    displayWrappers.forEach(wrapper => {
      // Verificar si el contenido es más ancho que el contenedor
      const checkScroll = () => {
        if (wrapper.scrollWidth > wrapper.clientWidth) {
          wrapper.classList.add('has-scroll');
        } else {
          wrapper.classList.remove('has-scroll');
        }
      };
      
      checkScroll();
      
      // Detectar cuando scrollea hasta el final
      wrapper.addEventListener('scroll', () => {
        const isAtEnd = wrapper.scrollLeft + wrapper.clientWidth >= wrapper.scrollWidth - 5;
        if (isAtEnd) {
          wrapper.classList.add('scrolled-end');
        } else {
          wrapper.classList.remove('scrolled-end');
        }
      });
    });
    
    // Observar cambios de tamaño de ventana
    const resizeObserver = new ResizeObserver(entries => {
      entries.forEach(entry => {
        const wrapper = entry.target;
        if (wrapper.scrollWidth > wrapper.clientWidth) {
          wrapper.classList.add('has-scroll');
        } else {
          wrapper.classList.remove('has-scroll');
          wrapper.classList.remove('scrolled-end');
        }
      });
    });
    
    displayWrappers.forEach(wrapper => {
      resizeObserver.observe(wrapper);
    });
  });
</script>

